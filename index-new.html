<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMAP Speicher-Analyse</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      :root {
        --primary-color: #0077cc;
        --secondary-color: #4a90e2;
        --accent-color: #00a8cc;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --light-bg: #f8f9fa;
        --dark-bg: #343a40;
        --border-color: #dee2e6;
        --text-color: #333;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .card {
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 119, 204, 0.1);
      }

      .form-row {
        display: flex;
        gap: 1rem;
        align-items: end;
      }

      .form-row .form-group {
        flex: 1;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
        background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
      }

      .btn-secondary {
        background: var(--light-bg);
        color: var(--text-color);
        border: 2px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-color);
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .progress-bar {
        width: 100%;
        max-width: 400px;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem auto;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 10px;
        position: relative;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .visualization {
        display: none;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        height: 85vh;
      }

      .visualization.active {
        display: block;
      }

      .viz-header {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .viz-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .viz-content {
        display: flex;
        height: calc(85vh - 80px);
      }

      .sidebar {
        width: 280px;
        background: var(--light-bg);
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        padding: 1rem 0;
      }

      .sidebar-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .sidebar-item:hover {
        background: rgba(0, 119, 204, 0.1);
        border-left-color: var(--primary-color);
      }

      .sidebar-item.active {
        background: rgba(0, 119, 204, 0.15);
        border-left-color: var(--primary-color);
        font-weight: 600;
      }

      .sidebar-item.folder {
        font-weight: 600;
      }

      .sidebar-toggle {
        color: #666;
        font-size: 0.9rem;
        margin-left: 0.5rem;
        user-select: none;
      }

      .chart-container {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      .node {
        position: absolute;
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 11px;
        padding: 4px;
        word-wrap: break-word;
      }

      .node:hover {
        border-color: var(--primary-color);
        border-width: 2px;
        box-shadow: 0 2px 8px rgba(0, 119, 204, 0.3);
        z-index: 100;
      }

      .node.selected {
        border-color: var(--primary-color);
        border-width: 3px;
        box-shadow: 0 0 10px rgba(0, 119, 204, 0.5);
      }

      .node.mail {
        border-style: dashed;
        border-radius: 8px;
      }

      .parent-node {
        position: absolute;
        border: 2px solid rgba(51, 51, 51, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
        backdrop-filter: blur(2px);
      }

      .parent-label {
        position: absolute;
        left: 8px;
        top: 4px;
        font-weight: 600;
        font-size: 12px;
        color: #333;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      }

      .info-panel {
        background: var(--light-bg);
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        height: 120px;
        overflow-y: auto;
      }

      .info-panel h3 {
        margin: 0 0 0.5rem 0;
        color: var(--primary-color);
      }

      .info-panel p {
        margin: 0.25rem 0;
        font-size: 0.9rem;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.3rem;
      }

      .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        padding: 1.5rem;
      }

      .mail-detail {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .mail-detail:last-child {
        border-bottom: none;
      }

      .mail-detail label {
        font-weight: 600;
        color: var(--text-color);
        margin-right: 0.5rem;
      }

      .mail-content {
        background: var(--light-bg);
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
      }

      .attachment-list {
        margin-top: 1rem;
      }

      .attachment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: var(--light-bg);
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      .attachment-info {
        flex: 1;
      }

      .attachment-name {
        font-weight: 600;
        color: var(--text-color);
      }

      .attachment-size {
        font-size: 0.9rem;
        color: #666;
      }

      .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        border: 1px solid transparent;
      }

      .alert-success {
        background: rgba(40, 167, 69, 0.1);
        border-color: var(--success-color);
        color: var(--success-color);
      }

      .alert-error {
        background: rgba(220, 53, 69, 0.1);
        border-color: var(--danger-color);
        color: var(--danger-color);
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
      }

      .breadcrumb-item {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      .breadcrumb-item:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .breadcrumb-item.active {
        color: white;
        font-weight: 600;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        color: white;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .form-row {
          flex-direction: column;
        }

        .viz-content {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: 200px;
        }

        .chart-container {
          height: calc(85vh - 280px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>📧 IMAP Speicher-Analyse</h1>
        <p>Analysieren Sie Ihren E-Mail-Speicher visuell und interaktiv</p>
      </div>

      <!-- Login Form -->
      <div id="loginSection" class="card">
        <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">
          🔐 IMAP-Verbindung konfigurieren
        </h2>
        <form id="imapForm">
          <div class="form-row">
            <div class="form-group">
              <label for="server">IMAP Server</label>
              <input type="text" id="server" name="server" class="form-control" required placeholder="z.B. imap.gmail.com" />
            </div>
            <div class="form-group">
              <label for="port">Port</label>
              <input type="number" id="port" name="port" class="form-control" value="993" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="user">Benutzername</label>
              <input type="text" id="user" name="user" class="form-control" required placeholder="ihre.email@example.com" />
            </div>
            <div class="form-group">
              <label for="pass">Passwort</label>
              <input type="password" id="pass" name="pass" class="form-control" required placeholder="••••••••" />
            </div>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="ssl" name="ssl" checked />
              <label for="ssl">SSL-Verschlüsselung verwenden</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            🔍 Analyse starten
          </button>
        </form>
      </div>

      <!-- Loading Section -->
      <div id="loadingSection" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Verbindung wird aufgebaut und E-Mails analysiert...</p>
        <div id="progressContainer" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p id="progressText">0% - Initialisierung...</p>
          <p id="progressDetails" style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
            Bitte haben Sie Geduld. Große Postfächer werden schrittweise analysiert.
          </p>
        </div>
      </div>

      <!-- Visualization Section -->
      <div id="visualizationSection" class="visualization">
        <div class="viz-header">
          <h2>📊 Speicher-Visualisierung</h2>
          <div class="breadcrumb" id="breadcrumb">
            <!-- Breadcrumb wird dynamisch gefüllt -->
          </div>
          <button class="btn btn-secondary" onclick="showLogin()">
            🔄 Neue Analyse
          </button>
        </div>
        <div class="stats-grid" id="statsGrid">
          <!-- Statistiken werden dynamisch gefüllt -->
        </div>
        <div class="viz-content">
          <div class="sidebar" id="sidebar">
            <!-- Ordnerbaum wird hier eingefügt -->
          </div>
          <div class="chart-container" id="chartContainer">
            <!-- Treemap wird hier eingefügt -->
          </div>
        </div>
        <div class="info-panel" id="infoPanel">
          <h3>ℹ️ Informationen</h3>
          <p>Klicken Sie auf ein Element, um Details anzuzeigen</p>
        </div>
      </div>
    </div>

    <script>
      // Globale Variablen
      let imapData = null;
      let currentData = null;
      let history = [];
      let selectedUid = null;
      let currentModal = null;

      // Utility-Funktionen
      const formatSize = (bytes) => {
        if (!bytes || bytes === 0) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${units[i]}`;
      };

      const formatNumber = (num) => {
        return new Intl.NumberFormat('de-DE').format(num);
      };

      const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      };

      // Initialisierung
      document.addEventListener('DOMContentLoaded', function() {
        loadFormData();
        checkExistingData();
        setupEventListeners();
      });

      function loadFormData() {
        ['server', 'port', 'user', 'ssl', 'pass'].forEach(id => {
          const element = document.getElementById(id);
          const value = localStorage.getItem(id);
          if (value && element) {
            if (element.type === 'checkbox') {
              element.checked = value === 'true';
            } else {
              element.value = value;
            }
          }
        });
      }

      function saveFormData() {
        ['server', 'port', 'user', 'ssl', 'pass'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            const value = element.type === 'checkbox' ? element.checked : element.value;
            localStorage.setItem(id, value);
          }
        });
      }

      function checkExistingData() {
        const existingData = localStorage.getItem('imapTreeData');
        if (existingData) {
          try {
            imapData = JSON.parse(existingData);
            currentData = imapData;
            showVisualization();
          } catch (e) {
            console.error('Fehler beim Laden der gespeicherten Daten:', e);
            localStorage.removeItem('imapTreeData');
          }
        }
      }

      function setupEventListeners() {
        document.getElementById('imapForm').addEventListener('submit', handleFormSubmit);
        window.addEventListener('resize', debounce(handleResize, 300));
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        
        saveFormData();
        showLoading();

        const formData = new FormData(e.target);
        
        try {
          // Entscheidung zwischen normalem und progressivem Scan
          const useProgressiveScan = confirm(
            'Ihr Postfach wird analysiert.\n\n' +
            'Für große Postfächer (>5GB) empfehlen wir den progressiven Scan.\n\n' +
            'Klicken Sie "OK" für progressiven Scan oder "Abbrechen" für normalen Scan.'
          );

          if (useProgressiveScan) {
            await handleProgressiveScan(formData);
          } else {
            await handleNormalScan(formData);
          }
          
        } catch (error) {
          console.error('Fehler beim Laden der IMAP-Daten:', error);
          showError('Verbindung fehlgeschlagen: ' + error.message);
          showLogin();
        }
      }

      async function handleNormalScan(formData) {
        const response = await fetch('imap-scan.php', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        imapData = data;
        currentData = data;
        localStorage.setItem('imapTreeData', JSON.stringify(data));
        showVisualization();
      }

      async function handleProgressiveScan(formData) {
        // Schritt 1: Initialisierung
        updateLoadingText('Verbindung wird aufgebaut...');
        
        formData.append('action', 'init');
        const initResponse = await fetch('imap-scan-progressive.php', {
          method: 'POST',
          body: formData
        });

        if (!initResponse.ok) {
          throw new Error(`HTTP ${initResponse.status}: ${initResponse.statusText}`);
        }

        const initData = await initResponse.json();
        
        if (initData.error) {
          throw new Error(initData.error);
        }

        // Schritt 2: Ordner scannen
        showProgressBar();
        updateLoadingText('Ordner werden analysiert...');
        
        const results = [];
        const cacheKey = initData.cacheKey;
        
        for (let i = 0; i < initData.totalFolders; i++) {
          const folderFormData = new FormData();
          folderFormData.append('server', localStorage.getItem('server'));
          folderFormData.append('port', localStorage.getItem('port'));
          folderFormData.append('user', localStorage.getItem('user'));
          folderFormData.append('pass', localStorage.getItem('pass'));
          folderFormData.append('ssl', localStorage.getItem('ssl'));
          folderFormData.append('action', 'scan');
          folderFormData.append('cacheKey', cacheKey);
          folderFormData.append('folderIndex', i.toString());
          
          const scanResponse = await fetch('imap-scan-progressive.php', {
            method: 'POST',
            body: folderFormData
          });

          if (!scanResponse.ok) {
            console.warn(`Fehler beim Scannen von Ordner ${i}: HTTP ${scanResponse.status}`);
            continue;
          }

          const scanData = await scanResponse.json();
          
          if (scanData.error) {
            console.warn(`Fehler beim Scannen von Ordner ${i}: ${scanData.error}`);
            continue;
          }

          // Fortschritt aktualisieren
          updateProgress(scanData.progress.percent, 
            `${scanData.progress.current}/${scanData.progress.total} - ${scanData.folder.name}`);
          
          results.push(scanData.folder);
          
          // Kurze Pause zwischen Requests
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Schritt 3: Finalisierung
        updateLoadingText('Ergebnisse werden zusammengefasst...');
        
        const finalizeFormData = new FormData();
        finalizeFormData.append('server', localStorage.getItem('server'));
        finalizeFormData.append('port', localStorage.getItem('port'));
        finalizeFormData.append('user', localStorage.getItem('user'));
        finalizeFormData.append('pass', localStorage.getItem('pass'));
        finalizeFormData.append('ssl', localStorage.getItem('ssl'));
        finalizeFormData.append('action', 'finalize');
        finalizeFormData.append('cacheKey', cacheKey);
        
        const finalResponse = await fetch('imap-scan-progressive.php', {
          method: 'POST',
          body: finalizeFormData
        });

        if (!finalResponse.ok) {
          throw new Error(`HTTP ${finalResponse.status}: ${finalResponse.statusText}`);
        }

        const finalData = await finalResponse.json();
        
        if (finalData.error) {
          throw new Error(finalData.error);
        }

        imapData = finalData;
        currentData = finalData;
        localStorage.setItem('imapTreeData', JSON.stringify(finalData));
        showVisualization();
      }

      function updateLoadingText(text) {
        const loadingText = document.getElementById('loadingText');
        if (loadingText) {
          loadingText.textContent = text;
        }
      }

      function showProgressBar() {
        const progressContainer = document.getElementById('progressContainer');
        if (progressContainer) {
          progressContainer.style.display = 'block';
        }
      }

      function updateProgress(percent, details) {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');
        
        if (progressFill) {
          progressFill.style.width = percent + '%';
        }
        
        if (progressText) {
          progressText.textContent = `${percent}% - Analyse läuft...`;
        }
        
        if (progressDetails && details) {
          progressDetails.textContent = `Aktueller Ordner: ${details}`;
        }
      }

      function showLogin() {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('loadingSection').classList.remove('active');
        document.getElementById('visualizationSection').classList.remove('active');
        history = [];
        selectedUid = null;
      }

      function showLoading() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('loadingSection').classList.add('active');
        document.getElementById('visualizationSection').classList.remove('active');
        
        // Fortschrittsanzeige zurücksetzen
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');
        
        if (progressContainer) progressContainer.style.display = 'none';
        if (progressFill) progressFill.style.width = '0%';
        if (progressText) progressText.textContent = '0% - Initialisierung...';
        if (progressDetails) progressDetails.textContent = 'Bitte haben Sie Geduld. Große Postfächer werden schrittweise analysiert.';
      }

      function showVisualization() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('loadingSection').classList.remove('active');
        document.getElementById('visualizationSection').classList.add('active');
        
        updateStats();
        updateBreadcrumb();
        renderSidebar();
        renderTreemap();
      }

      function showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-error';
        alert.textContent = message;
        
        const container = document.querySelector('.container');
        container.insertBefore(alert, container.firstChild);
        
        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      function updateStats() {
        if (!currentData) return;

        const stats = calculateStats(currentData);
        const statsGrid = document.getElementById('statsGrid');
        
        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${formatNumber(stats.totalMails)}</div>
            <div class="stat-label">E-Mails</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${formatSize(stats.totalSize)}</div>
            <div class="stat-label">Gesamtgröße</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${formatNumber(stats.totalFolders)}</div>
            <div class="stat-label">Ordner</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${formatSize(stats.avgMailSize)}</div>
            <div class="stat-label">⌀ Mail-Größe</div>
          </div>
        `;
      }

      function calculateStats(data) {
        const stats = {
          totalMails: 0,
          totalSize: 0,
          totalFolders: 0,
          avgMailSize: 0
        };

        function traverse(node) {
          if (node.type === 'mail') {
            stats.totalMails++;
            stats.totalSize += node.size || 0;
          } else if (node.type === 'other-mails') {
            stats.totalMails += node.count || 0;
            stats.totalSize += node.size || 0;
          } else if (node.children) {
            stats.totalFolders++;
            node.children.forEach(traverse);
          }
        }

        traverse(data);
        stats.avgMailSize = stats.totalMails > 0 ? stats.totalSize / stats.totalMails : 0;
        return stats;
      }

      function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        const path = [];
        
        let current = currentData;
        while (current && current !== imapData) {
          path.unshift(current);
          current = current.parent; // Assuming parent reference exists
        }
        
        let html = '<span class="breadcrumb-item" onclick="navigateToRoot()">🏠 Root</span>';
        path.forEach((item, index) => {
          html += ` <span style="color: rgba(255,255,255,0.5);">›</span> `;
          html += `<span class="breadcrumb-item ${index === path.length - 1 ? 'active' : ''}" 
                     onclick="navigateToLevel(${index})">${item.name}</span>`;
        });
        
        breadcrumb.innerHTML = html;
      }

      function navigateToRoot() {
        history = [];
        currentData = imapData;
        showVisualization();
      }

      function navigateToLevel(level) {
        // Implementation for navigating to specific level
        // This would require storing the navigation path
      }

      function renderSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.innerHTML = '';
        
        if (currentData && currentData.children) {
          renderSidebarItems(currentData.children, sidebar, 0);
        }
      }

      function renderSidebarItems(items, container, depth) {
        items.forEach(item => {
          const element = document.createElement('div');
          element.className = 'sidebar-item';
          element.style.paddingLeft = `${depth * 20 + 16}px`;
          
          if (item.children) {
            element.classList.add('folder');
          }
          
          const icon = item.type === 'mail' ? '📧' : 
                       item.type === 'other-mails' ? '📦' : '📁';
          
          element.innerHTML = `
            <span>${icon} ${item.name}</span>
            <span style="color: #666; font-size: 0.9rem;">${formatSize(item.size || item.childrenTotalSize || 0)}</span>
            ${item.children && item.children.length > 0 ? '<span class="sidebar-toggle">▶</span>' : ''}
          `;
          
          element.addEventListener('click', (e) => {
            e.stopPropagation();
            handleSidebarItemClick(item);
          });
          
          container.appendChild(element);
          
          if (item.children) {
            const childContainer = document.createElement('div');
            childContainer.style.display = 'none';
            renderSidebarItems(item.children, childContainer, depth + 1);
            container.appendChild(childContainer);
            
            const toggle = element.querySelector('.sidebar-toggle');
            if (toggle) {
              toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isExpanded = childContainer.style.display === 'block';
                childContainer.style.display = isExpanded ? 'none' : 'block';
                toggle.textContent = isExpanded ? '▶' : '▼';
              });
            }
          }
        });
      }

      function handleSidebarItemClick(item) {
        if (item.type === 'mail') {
          selectedUid = item.uid;
          highlightSelectedItem();
          showItemInfo(item);
          showMailModal(item);
        } else if (item.type === 'other-mails') {
          selectedUid = item.name;
          highlightSelectedItem();
          showItemInfo(item);
        } else if (item.children) {
          history.push(currentData);
          currentData = item;
          showVisualization();
        }
      }

      function renderTreemap() {
        const container = document.getElementById('chartContainer');
        container.innerHTML = '';
        
        if (!currentData || !currentData.children) return;
        
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        const root = d3.hierarchy(currentData)
          .sum(d => d.size || 0)
          .sort((a, b) => b.value - a.value);
        
        d3.treemap()
          .size([width, height])
          .padding(2)
          .round(true)(root);
        
        const svg = d3.select(container)
          .append('svg')
          .attr('width', width)
          .attr('height', height);
        
        const baseColors = [
          '#e63946', '#457b9d', '#2a9d8f', '#f4a261',
          '#a8dadc', '#b7b7a4', '#ffb4a2', '#6d6875'
        ];
        
        // Parent folders
        svg.selectAll('.parent-node')
          .data(root.descendants().filter(d => d.depth === 1))
          .enter()
          .append('rect')
          .attr('class', 'parent-node')
          .attr('x', d => d.x0 - 2)
          .attr('y', d => d.y0 - 2)
          .attr('width', d => d.x1 - d.x0 + 4)
          .attr('height', d => d.y1 - d.y0 + 4)
          .attr('fill', 'rgba(255,255,255,0.1)')
          .attr('stroke', 'rgba(51,51,51,0.3)')
          .attr('stroke-width', 2)
          .attr('rx', 6);
        
        // Parent labels
        svg.selectAll('.parent-label')
          .data(root.descendants().filter(d => d.depth === 1))
          .enter()
          .append('text')
          .attr('class', 'parent-label')
          .attr('x', d => d.x0 + 6)
          .attr('y', d => d.y0 + 16)
          .attr('font-size', '12px')
          .attr('font-weight', 'bold')
          .attr('fill', '#333')
          .text(d => `📁 ${d.data.name}`);
        
        // Leaf nodes
        const nodes = svg.selectAll('.node')
          .data(root.leaves())
          .enter()
          .append('g')
          .attr('class', 'node')
          .attr('transform', d => `translate(${d.x0},${d.y0})`);
        
        nodes.append('rect')
          .attr('width', d => d.x1 - d.x0)
          .attr('height', d => d.y1 - d.y0)
          .attr('fill', d => {
            let rootChild = d;
            while (rootChild.depth > 1) rootChild = rootChild.parent;
            const idx = root.children.indexOf(rootChild);
            const baseColor = baseColors[idx % baseColors.length];
            const intensity = Math.min((d.depth - 1) * 0.15, 0.6);
            return shadeColor(baseColor, intensity);
          })
          .attr('stroke', 'rgba(255,255,255,0.8)')
          .attr('stroke-width', 1)
          .attr('rx', d => d.data.type === 'mail' ? 4 : 2)
          .style('cursor', 'pointer')
          .on('mouseover', function(event, d) {
            d3.select(this)
              .attr('stroke', 'var(--primary-color)')
              .attr('stroke-width', 2)
              .style('filter', 'drop-shadow(2px 2px 4px rgba(0,119,204,0.3))');
          })
          .on('mouseout', function(event, d) {
            d3.select(this)
              .attr('stroke', 'rgba(255,255,255,0.8)')
              .attr('stroke-width', 1)
              .style('filter', 'none');
          });
        
        nodes.append('text')
          .attr('x', 4)
          .attr('y', 16)
          .attr('font-size', '10px')
          .attr('fill', '#333')
          .style('pointer-events', 'none')
          .text(d => {
            const icon = d.data.type === 'mail' ? '📧' : 
                        d.data.type === 'other-mails' ? '📦' : '📁';
            return `${icon} ${d.data.name}`;
          });
        
        nodes.on('click', (event, d) => {
          selectedUid = d.data.uid || d.data.name;
          highlightSelectedItem();
          showItemInfo(d.data);
          
          if (d.data.type === 'mail') {
            showMailModal(d.data);
          }
        });
      }

      function shadeColor(color, percent) {
        const f = parseInt(color.slice(1), 16);
        const t = percent < 0 ? 0 : 255;
        const p = percent < 0 ? percent * -1 : percent;
        const R = f >> 16;
        const G = (f >> 8) & 0x00FF;
        const B = f & 0x0000FF;
        
        return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + 
                     (Math.round((t - G) * p) + G) * 0x100 + 
                     (Math.round((t - B) * p) + B)).toString(16).slice(1);
      }

      function highlightSelectedItem() {
        // Remove previous highlights
        document.querySelectorAll('.sidebar-item.active').forEach(item => {
          item.classList.remove('active');
        });
        
        // Add highlight to selected item
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        sidebarItems.forEach(item => {
          if (item.textContent.includes(selectedUid)) {
            item.classList.add('active');
          }
        });
      }

      function showItemInfo(item) {
        const infoPanel = document.getElementById('infoPanel');
        let html = `<h3>📄 ${item.name}</h3>`;
        html += `<p><strong>Größe:</strong> ${formatSize(item.size || 0)}</p>`;
        
        if (item.type === 'mail') {
          html += `<p><strong>Von:</strong> ${item.from || 'Unbekannt'}</p>`;
          html += `<p><strong>Datum:</strong> ${item.date || 'Unbekannt'}</p>`;
          html += `<p><strong>UID:</strong> ${item.uid || 'Unbekannt'}</p>`;
        } else if (item.type === 'other-mails') {
          html += `<p><strong>Typ:</strong> Zusammengefasste E-Mails</p>`;
          html += `<p><strong>Anzahl:</strong> ${item.count || 'Unbekannt'}</p>`;
        }
        
        if (history.length > 0) {
          html += `<button class="btn btn-secondary" onclick="navigateBack()" style="margin-top: 1rem;">⬅️ Zurück</button>`;
        }
        
        infoPanel.innerHTML = html;
      }

      function navigateBack() {
        if (history.length > 0) {
          currentData = history.pop();
          showVisualization();
        }
      }

      function handleResize() {
        if (document.getElementById('visualizationSection').classList.contains('active')) {
          renderTreemap();
        }
      }

      async function showMailModal(mail) {
        try {
          const mailContent = await fetchMailContent(mail);
          createMailModal(mailContent, mail);
        } catch (error) {
          console.error('Fehler beim Laden der Mail:', error);
          showError('Fehler beim Laden der E-Mail-Details');
        }
      }

      async function fetchMailContent(mail) {
        const formData = new FormData();
        formData.append('server', localStorage.getItem('server'));
        formData.append('port', localStorage.getItem('port'));
        formData.append('user', localStorage.getItem('user'));
        formData.append('pass', localStorage.getItem('pass'));
        formData.append('ssl', localStorage.getItem('ssl'));
        formData.append('folder', mail.folderFull || mail.folder || '');
        formData.append('uid', mail.uid);
        
        const response = await fetch('imap-mail.php', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
      }

      function createMailModal(mailContent, mail) {
        // Remove existing modal
        if (currentModal) {
          currentModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>📧 ${mailContent.subject || 'Kein Betreff'}</h2>
              <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="mail-detail">
                <label>Von:</label>
                <span>${mailContent.from || 'Unbekannt'}</span>
              </div>
              <div class="mail-detail">
                <label>Datum:</label>
                <span>${mailContent.date || 'Unbekannt'}</span>
              </div>
              <div class="mail-detail">
                <label>Größe:</label>
                <span>${formatSize(mail.size || 0)}</span>
              </div>
              ${mailContent.attachments && mailContent.attachments.length > 0 ? `
                <div class="mail-detail">
                  <label>Anhänge:</label>
                  <div class="attachment-list">
                    ${mailContent.attachments.map(att => `
                      <div class="attachment-item">
                        <div class="attachment-info">
                          <div class="attachment-name">📎 ${att.filename}</div>
                          <div class="attachment-size">${formatSize(att.size)}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="downloadAttachment('${att.filename}', '${att.partNum}', '${mail.uid}', '${mail.folderFull || mail.folder}')">
                          💾 Download
                        </button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              <div class="mail-detail">
                <label>Nachricht:</label>
                <div class="mail-content">${mailContent.html || mailContent.text || 'Kein Inhalt verfügbar'}</div>
              </div>
              <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-danger" onclick="deleteMail('${mail.uid}', '${mail.folderFull || mail.folder}')">
                  🗑️ E-Mail löschen
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                  Schließen
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        currentModal = modal;
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
      }

      function closeModal() {
        if (currentModal) {
          currentModal.remove();
          currentModal = null;
        }
      }

      async function downloadAttachment(filename, partNum, uid, folder) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = 'imap-download.php';
        form.target = '_blank';
        
        const fields = {
          server: localStorage.getItem('server'),
          port: localStorage.getItem('port'),
          user: localStorage.getItem('user'),
          pass: localStorage.getItem('pass'),
          ssl: localStorage.getItem('ssl'),
          folder: folder,
          uid: uid,
          partNum: partNum,
          filename: filename
        };
        
        Object.entries(fields).forEach(([key, value]) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
      }

      async function deleteMail(uid, folder) {
        if (!confirm('Möchten Sie diese E-Mail wirklich löschen?')) {
          return;
        }
        
        try {
          const formData = new FormData();
          formData.append('server', localStorage.getItem('server'));
          formData.append('port', localStorage.getItem('port'));
          formData.append('user', localStorage.getItem('user'));
          formData.append('pass', localStorage.getItem('pass'));
          formData.append('ssl', localStorage.getItem('ssl'));
          formData.append('folder', folder);
          formData.append('uid', uid);
          
          const response = await fetch('imap-delete.php', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            closeModal();
            showError('E-Mail erfolgreich gelöscht!');
            
            // Refresh data
            const refreshFormData = new FormData();
            refreshFormData.append('server', localStorage.getItem('server'));
            refreshFormData.append('port', localStorage.getItem('port'));
            refreshFormData.append('user', localStorage.getItem('user'));
            refreshFormData.append('pass', localStorage.getItem('pass'));
            refreshFormData.append('ssl', localStorage.getItem('ssl'));
            
            const refreshResponse = await fetch('imap-scan.php', {
              method: 'POST',
              body: refreshFormData
            });
            
            const newData = await refreshResponse.json();
            imapData = newData;
            currentData = newData;
            localStorage.setItem('imapTreeData', JSON.stringify(newData));
            showVisualization();
            
          } else {
            throw new Error(result.error || 'Unbekannter Fehler');
          }
        } catch (error) {
          console.error('Fehler beim Löschen:', error);
          showError('Fehler beim Löschen der E-Mail: ' + error.message);
        }
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentModal) {
          closeModal();
        }
        if (e.key === 'Backspace' && history.length > 0 && !currentModal) {
          navigateBack();
        }
      });
    </script>
  </body>
</html>
